<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guitar Tab Trainer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
    }

    h1 {
      margin: 0 0 12px 0;
    }

    button,
    input,
    select {
      font-size: 16px;
    }

    button {
      padding: 10px 14px;
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .panel {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      min-width: 320px;
    }

    .big {
      font-size: 20px;
      font-weight: 650;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    label {
      display: block;
      font-size: 12px;
      opacity: 0.75;
      margin-bottom: 6px;
    }

    /* File upload styles */
    .upload-section {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      text-align: center;
      background: #f9f9f9;
      transition: all 0.2s ease;
    }

    .upload-section.dragover {
      border-color: #007bff;
      background: #e6f3ff;
    }

    .upload-section input[type="file"] {
      margin: 8px 0;
    }

    .upload-status {
      margin-top: 8px;
      font-size: 14px;
    }

    .upload-status.success {
      color: #1a7f37;
    }

    .upload-status.error {
      color: #b42318;
    }

    .notes {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .note {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 12px;
      min-width: 84px;
      text-align: center;
    }

    .note .t {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 6px;
    }

    .note.hit {
      border-color: #1a7f37;
    }

    .note.miss {
      border-color: #b42318;
    }

    .note.skipped {
      border-color: #ff9900;
      opacity: 0.7;
    }

    .note.next {
      border-width: 2px;
    }

    /* Guitar fretboard styles */
    .fretboard {
      position: relative;
      width: 100%;
      height: 420px;
      background: linear-gradient(to bottom, #2a2a2a 0%, #1a1a1a 100%);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 12px;
    }

    .string {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: #888;
      border-radius: 1px;
    }

    .string.e-high {
      top: 45px;
    }

    .string.b {
      top: 105px;
    }

    .string.g {
      top: 165px;
    }

    .string.d {
      top: 225px;
    }

    .string.a {
      top: 285px;
    }

    .string.e-low {
      top: 345px;
    }

    .hit-zone {
      position: absolute;
      left: 60px;
      top: 0;
      bottom: 0;
      width: 4px;
      background: #00ff88;
      box-shadow: 0 0 10px #00ff88;
      z-index: 10;
      transition: all 0.2s ease;
    }

    .hit-zone.hit-feedback {
      background: #00ff00;
      box-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00;
      width: 8px;
      transform: scaleY(1.2);
    }

    .hit-zone.miss-feedback {
      background: #ff4444;
      box-shadow: 0 0 30px #ff4444, 0 0 60px #ff4444;
      width: 8px;
      transform: scaleY(1.2);
    }

    .hit-zone.skip-feedback {
      background: #ff9900;
      box-shadow: 0 0 20px #ff9900, 0 0 40px #ff9900;
      width: 6px;
      transform: scaleY(1.1);
    }

    /* Full-screen feedback overlay */
    .feedback-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s ease;
    }

    .feedback-overlay.hit {
      background: radial-gradient(circle, rgba(26, 127, 55, 0.3) 0%, rgba(26, 127, 55, 0.1) 50%, transparent 100%);
      opacity: 1;
    }

    .feedback-overlay.miss {
      background: radial-gradient(circle, rgba(180, 35, 24, 0.3) 0%, rgba(180, 35, 24, 0.1) 50%, transparent 100%);
      opacity: 1;
    }

    /* Enhanced fret note feedback */
    .fret-note.hit {
      background: #1a7f37;
      box-shadow: 0 0 25px #1a7f37, 0 0 50px #1a7f37;
      transform: translateY(-50%) scaleY(1.3);
      border-color: #00ff00;
      border-width: 3px;
    }

    .fret-note.miss {
      background: #b42318;
      box-shadow: 0 0 25px #b42318, 0 0 50px #b42318;
      transform: translateY(-50%) scaleY(1.3);
      border-color: #ff4444;
      border-width: 3px;
    }

    .fret-note.skipped {
      background: #ff9900;
      box-shadow: 0 0 15px #ff9900, 0 0 30px #ff9900;
      transform: translateY(-50%) scaleY(1.1);
      border-color: #ffaa33;
      border-width: 2px;
      opacity: 0.7;
    }

    .fret-note {
      position: absolute;
      min-width: 80px;
      height: 56px;
      border-radius: 16px;
      border: 5px solid #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 900;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      color: #000;
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      transform: translateY(-50%);
      transition: none;
      z-index: 5;
      box-sizing: border-box;
      text-shadow:
        1px 1px 2px rgba(255, 255, 255, 0.9),
        -1px -1px 2px rgba(255, 255, 255, 0.9),
        2px 2px 4px rgba(0, 0, 0, 0.3);
      box-shadow:
        0 0 0 2px #333,
        0 6px 20px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      will-change: transform;
      /* Anti-motion-blur techniques */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      transform-style: preserve-3d;
      /* Force hardware acceleration for smoother movement */
      -webkit-transform: translateZ(0) translateY(-50%);
      transform: translateZ(0) translateY(-50%);
      /* Prevent subpixel rendering issues and ensure crisp text */
      -webkit-transform: translate3d(0, -50%, 0);
      transform: translate3d(0, -50%, 0);
      /* Snap to pixel boundaries for crisp rendering */
      image-rendering: crisp-edges;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-optimize-contrast;
      /* Ensure text stays sharp during animation */
      -webkit-font-feature-settings: "liga" 0;
      font-feature-settings: "liga" 0;
    }

    .fret-note.open-string {
      background: linear-gradient(145deg, #9370db, #6a5acd);
      color: #fff;
      border-color: #4b0082;
      text-shadow:
        1px 1px 2px rgba(0, 0, 0, 0.8),
        -1px -1px 2px rgba(0, 0, 0, 0.5);
    }

    .fret-note.hit {
      background: linear-gradient(145deg, #22c55e, #16a34a);
      color: #fff;
      border-color: #15803d;
      box-shadow:
        0 0 0 2px #15803d,
        0 0 25px #22c55e,
        0 6px 20px rgba(0, 0, 0, 0.4);
      text-shadow:
        1px 1px 2px rgba(0, 0, 0, 0.8),
        -1px -1px 2px rgba(0, 0, 0, 0.5);
    }

    .fret-note.miss {
      background: linear-gradient(145deg, #ef4444, #dc2626);
      color: #fff;
      border-color: #b91c1c;
      box-shadow:
        0 0 0 2px #b91c1c,
        0 0 25px #ef4444,
        0 6px 20px rgba(0, 0, 0, 0.4);
      text-shadow:
        1px 1px 2px rgba(0, 0, 0, 0.8),
        -1px -1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Chord grouping styles */
    .chord-group {
      position: absolute;
      background: rgba(100, 150, 255, 0.1);
      border: 2px dashed rgba(100, 150, 255, 0.4);
      border-radius: 12px;
      z-index: 2;
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .chord-group.hit {
      background: rgba(26, 127, 55, 0.2);
      border-color: rgba(26, 127, 55, 0.6);
    }

    .chord-group.miss {
      background: rgba(180, 35, 24, 0.2);
      border-color: rgba(180, 35, 24, 0.6);
    }

    .chord-group.skipped {
      background: rgba(255, 153, 0, 0.2);
      border-color: rgba(255, 153, 0, 0.6);
    }

    .fret-note.chord-member {
      border-color: rgba(100, 150, 255, 0.6);
      box-shadow:
        0 0 0 2px rgba(100, 150, 255, 0.6),
        0 6px 20px rgba(0, 0, 0, 0.4);
    }

    .string-label {
      position: absolute;
      left: 10px;
      transform: translateY(-50%);
      font-size: 14px;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 0 3px #000;
    }

    .flash {
      outline: 3px solid #999;
      border-radius: 10px;
      padding: 4px 8px;
      display: inline-block;
    }

    progress {
      width: 100%;
      height: 18px;
    }

    .hint {
      opacity: 0.75;
      font-size: 13px;
      margin-top: 10px;
      line-height: 1.35;
    }

    /* ---- NEW CSS FOR PRACTICE MODE TABS ---- */
    .tab-view-container {
      margin-top: 20px;
      overflow-x: auto;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      white-space: nowrap;
      scrollbar-width: thin;
    }

    .tab-track {
      display: inline-flex;
      position: relative;
      padding-bottom: 20px;
    }

    .tab-measure {
      position: relative;
      width: 250px;
      height: 120px;
      border-right: 2px solid #888;
      box-sizing: border-box;
      flex-shrink: 0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tab-measure:hover {
      background-color: #f0f8ff;
    }

    .tab-measure.selected {
      background-color: #e6f3ff;
      border-bottom: 4px solid #007bff;
    }

    .tab-string-line {
      position: absolute;
      left: 0;
      right: 0;
      height: 1px;
      background-color: #ccc;
    }

    .tab-measure-number {
      position: absolute;
      top: -20px;
      left: 0;
      font-size: 10px;
      color: #666;
    }

    .tab-note-marker {
      position: absolute;
      background: #fff;
      padding: 0 4px;
      font-family: monospace;
      font-weight: bold;
      font-size: 14px;
      transform: translate(-50%, -50%);
      z-index: 2;
    }
  </style>
</head>

<body>
  <h1>Tab Trainer (Single Notes)</h1>

  <div class="panel" style="margin-bottom: 20px;">
    <div class="row">
      <button id="btnMic">Enable Mic</button>
      <button id="btnStart" disabled>Start</button>
      <button id="btnStop" disabled>Stop</button>
      <div class="mono" id="status" style="opacity:0.8;">‚Äî</div>
    </div>

    <div class="row" style="margin-top:16px; gap:32px; flex-wrap:wrap;">
      <div style="min-width:200px;">
        <div style="margin-bottom:10px;">
          <label for="exercise">Exercise</label>
          <select id="exercise">
            <option value="">Loading exercises...</option>
          </select>
        </div>
      </div>

      <div style="min-width:300px;">
        <label>Upload MusicXML File</label>
        <div class="upload-section" id="uploadSection">
          <div>Drop a MusicXML file here or</div>
          <input type="file" id="musicxmlFile" accept=".mxl,.xml,.musicxml" />
          <div class="upload-status" id="uploadStatus"></div>
        </div>
      </div>

      <div style="min-width:220px;">
        <label for="bpm">BPM</label>
        <div class="row" style="gap:10px;">
          <input id="bpm" type="range" min="40" max="200" value="90" />
          <input id="bpmNum" type="number" min="40" max="200" value="90" style="width:90px;" />
        </div>
        <div style="margin-top:10px;">
          <label class="mono" style="display:flex; gap:10px; align-items:center; font-size:14px; opacity:1;">
            <input id="metroOn" type="checkbox" checked />
            Metronome
          </label>
          <label class="mono" style="display:flex; gap:10px; align-items:center; font-size:14px; opacity:1;">
            <input id="countInOn" type="checkbox" checked />
            4-beat count-in
          </label>
        </div>
      </div>

      <div style="min-width:200px;">
        <label for="fftThreshold">FFT Energy Threshold (dB)</label>
        <div class="row" style="gap:10px;">
          <input id="fftThreshold" type="range" min="-60" max="-20" value="-40" step="1" />
          <input id="fftThresholdNum" type="number" min="-60" max="-20" value="-40" step="1" style="width:70px;" />
        </div>
        <div style="margin-top:6px;">
          <label class="mono" style="display:flex; gap:6px; align-items:center; font-size:12px; margin-bottom:4px;">
            <input id="adaptiveCalibration" type="checkbox" checked />
            Auto-calibrate threshold
          </label>
          <label style="font-size: 0.8rem; color: #666; margin-top: 5px;">
            <input type="checkbox" id="debugMode">
            Enable Console Debug Logs
          </label>
          <button id="resetCalibration" style="font-size:11px; padding:4px 8px; margin-bottom:4px;">Reset
            Learning</button>
          <div class="mono" style="font-size:11px; opacity:0.7;">
            Auto adjusts for your mic and playing style
          </div>
          <div id="fftStatus" class="mono" style="font-size:12px; margin-top:4px;">‚Äî</div>
        </div>
      </div>

      <div style="min-width:180px;">
        <div id="micStatus" class="mono" style="margin-bottom:6px;">Not enabled</div>
        <progress id="level" value="0" max="1" style="width:100%; margin-bottom:4px;"></progress>
        <div id="levelText" class="mono" style="font-size:12px;">rms=‚Äî</div>
      </div>

      <div style="min-width:160px;">
        <div style="margin-bottom:4px;">
          <strong>Last Note:</strong>
          <div id="lastNote" class="mono" style="font-size:18px;">‚Äî</div>
        </div>
        <div id="now" class="mono" style="font-size:12px;">‚Äî</div>
      </div>

      <div style="min-width:140px;">
        <button id="btnCalibrate"
          style="font-size:16px; padding:12px; width:100%; margin-bottom:8px; background:#0066cc; color:white;">
          üé∏ Calibrate Hardware
        </button>
        <div id="calibrationStatus" class="mono" style="font-size:11px; text-align:center;">
          Not calibrated
        </div>
      </div>
    </div>
  </div>

  <div id="calibrationModal" class="panel"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; background:white; border:2px solid #007bff; box-shadow:0 4px 20px rgba(0,0,0,0.3); width:90%; max-width:500px;">
    <div style="text-align:center; padding:20px;">
      <h2 style="margin:0 0 16px 0; color:#007bff;">üé∏ Hardware Calibration</h2>
      <p style="margin:0 0 20px 0; font-size:14px; line-height:1.4;">
        Play each open string clearly when prompted. This calibrates the detection system for your specific microphone
        and guitar.
      </p>

      <div id="calibrationStep" style="margin:20px 0;">
        <div id="calibrationInstruction" style="font-size:18px; font-weight:bold; margin-bottom:12px;">
          Ready to start calibration
        </div>
        <div id="calibrationProgress" style="background:#f0f0f0; border-radius:10px; height:20px; margin:12px 0;">
          <div id="calibrationProgressBar"
            style="background:#007bff; height:100%; border-radius:10px; width:0%; transition:width 0.3s;"></div>
        </div>
        <div id="calibrationDetails" class="mono" style="font-size:12px; color:#666;">
          6 strings to calibrate: E(6) - A(5) - D(4) - G(3) - B(2) - E(1)
        </div>
      </div>

      <div id="calibrationResults"
        style="display:none; margin:20px 0; padding:16px; background:#f8f9fa; border-radius:8px;">
        <h4 style="margin:0 0 12px 0;">Calibration Results</h4>
        <div id="calibrationSummary" class="mono" style="font-size:12px;">
        </div>
      </div>

      <div style="margin-top:20px;">
        <button id="startCalibration"
          style="font-size:16px; padding:10px 20px; margin-right:10px; background:#1a7f37; color:white;">
          Start Calibration
        </button>
        <button id="skipCalibration" style="font-size:16px; padding:10px 20px; margin-right:10px;">
          Skip (Use Defaults)
        </button>
        <button id="closeCalibration" style="font-size:16px; padding:10px 20px;" disabled>
          Continue to Practice
        </button>
      </div>
    </div>
  </div>

  <div id="calibrationOverlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;">
  </div>

  <div class="panel" style="width: 100%; margin-bottom: 12px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <div class="big">Guitar Fretboard</div>
      <div id="scoreDisplay" style="display: flex; gap: 20px; font-size: 18px; font-weight: bold;">
        <div style="color: #1a7f37;">‚úì <span id="successCount">0</span></div>
        <div style="color: #b42318;">‚úó <span id="failCount">0</span></div>
        <div style="color: #ff9900;">‚äù <span id="skippedCount">0</span></div>
        <div style="color: #666;">Accuracy: <span id="accuracy">0%</span></div>
      </div>
    </div>

    <div class="fretboard" id="fretboard">
      <div class="string e-high"></div>
      <div class="string b"></div>
      <div class="string g"></div>
      <div class="string d"></div>
      <div class="string a"></div>
      <div class="string e-low"></div>

      <div class="string-label" style="top: 45px;">e</div>
      <div class="string-label" style="top: 105px;">B</div>
      <div class="string-label" style="top: 165px;">G</div>
      <div class="string-label" style="top: 225px;">D</div>
      <div class="string-label" style="top: 285px;">A</div>
      <div class="string-label" style="top: 345px;">E</div>

      <div class="hit-zone"></div>
    </div>

    <div id="notes" class="notes" style="margin-top:12px; display: none;"></div>

    <div class="hint">
      Notes move from right to left. Play them when the left edge reaches the green line.
    </div>
  </div>

  <div class="panel" style="margin-bottom: 12px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div class="big">Practice Selector</div>
      <div>
        <label style="display:inline-flex; align-items:center; gap:8px;">
          <input type="checkbox" id="loopMode"> <strong>Loop Selected Bars</strong>
        </label>
        <label style="display:inline-flex; align-items:center; gap:8px; font-size: 14px; color: #555;">
          <input type="checkbox" id="loopWait"> +4 Beat Wait
        </label>
      </div>
    </div>
    <div class="hint">Click notes/bars to select a practice loop range.</div>

    <div id="staticTab" class="tab-view-container">
      <div style="padding:20px; color:#999; text-align:center;">Load an exercise to see the tab here.</div>
    </div>
  </div>

  <details class="panel" style="margin-top: 12px;">
    <summary style="cursor: pointer; font-weight: bold;">Debug Information</summary>
    <div style="margin-top: 12px;">
      <div id="lastNoteMeta" class="mono" style="opacity:0.8; font-size:12px; margin-bottom:8px;">‚Äî</div>

      <div style="margin-top: 12px;">
        <div style="font-weight: bold; margin-bottom: 8px;">Debug Log (all events):</div>
        <div id="debugLog" class="mono"
          style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; padding: 8px; font-size: 10px; max-height: 200px; overflow-y: auto;">
          <div style="opacity: 0.6;">Debug information will appear here when notes are played...</div>
        </div>
        <button id="clearDebug" style="margin-top: 8px; padding: 4px 8px; font-size: 12px;">Clear Log</button>
        <button id="copyDebug" style="margin-top: 8px; margin-left: 8px; padding: 4px 8px; font-size: 12px;">Copy to
          Clipboard</button>
      </div>

      <div class="hint" style="margin-top: 12px;">
        Debug tip: pluck one string cleanly (open A or D) and let it ring.
        Low E can be harder to detect.
      </div>
    </div>
  </details>

  <details class="panel" style="margin-top: 12px;">
    <summary style="cursor: pointer; font-weight: bold;">Practice History</summary>
    <div style="margin-top: 12px;">
      <div id="practiceHistory"
        style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; padding: 8px; font-size: 12px; max-height: 300px; overflow-y: auto;">
        <div style="opacity: 0.6; text-align: center; padding: 20px;">No practice sessions yet. Complete an exercise to
          see your history!</div>
      </div>
      <button id="clearHistory" style="margin-top: 8px; padding: 4px 8px; font-size: 12px;">Clear History</button>
    </div>
  </details>

  <div id="feedbackOverlay" class="feedback-overlay"></div>

  <script type="module" src="js/main.js"></script>
</body>

</html>